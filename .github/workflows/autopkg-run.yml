name: AutoPkg Recipe Runner

on:
  workflow_dispatch: # Allows manual triggering
    inputs:
      runner:
        description: "Runner to use (ubuntu-latest or macos-latest)"
        required: false
        default: "ubuntu-latest"
        type: choice
        options:
          - ubuntu-latest
          - macos-latest
  repository_dispatch:
    types: [run-autopkg]
  # push:
  #   branches:
  #     - "**" # Runs on push to any branch
  # schedule:
  #     - cron: "0 0 * * *" # Runs daily at midnight UTC (optional)

jobs:
  run-autopkg:
    runs-on: ${{ inputs.runner || github.event.client_payload.runner || 'ubuntu-latest' }}
    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Decode and save JSON payload
        if: github.event_name == 'repository_dispatch'
        run: |
          # Write payload to temp file using heredoc to avoid logging
          cat > /tmp/payload.b64 << 'PAYLOAD_EOF'
          ${{ github.event.client_payload.data }}
          PAYLOAD_EOF

          # Decode to JSON file
          base64 --decode /tmp/payload.b64 > /tmp/autopkg-keys.json
          rm /tmp/payload.b64

          # Verify JSON is valid
          echo "Verifying JSON structure..."
          if ! jq empty /tmp/autopkg-keys.json 2>&1; then
            echo "ERROR: Failed to parse JSON file"
            echo "File contents (first 200 chars):"
            head -c 200 /tmp/autopkg-keys.json || true
            exit 1
          fi
          echo "JSON structure is valid"

          # Immediately mask all sensitive values
          echo "Masking sensitive values..."
          while IFS= read -r value; do
            if [[ -n "$value" && "$value" != "null" ]]; then
              echo "::add-mask::$value"
              echo "Masked a value"
            fi
          done < <(jq -r 'try .JSS_URL // "", try .JSS_API_USER // "", try .JSS_API_PW // "", try .GH_TOKEN // ""' /tmp/autopkg-keys.json)

          echo "Masking complete"
          echo "Decoded JSON payload saved to /tmp/autopkg-keys.json"

      - name: Set up AutoPkg
        run: |
          chmod +x setup.sh
          ./setup.sh

      - name: Set up JamfUploader
        env:
          SECRET_JSS_URL: ${{ secrets.JSS_URL }}
          SECRET_JSS_API_USER: ${{ secrets.JSS_API_USER }}
          SECRET_JSS_API_PW: ${{ secrets.JSS_API_PW }}
          SECRET_GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          chmod +x setup-jamfuploader.sh

          # Mask secrets immediately
          [[ -n "$SECRET_JSS_URL" ]] && echo "::add-mask::$SECRET_JSS_URL"
          [[ -n "$SECRET_JSS_API_USER" ]] && echo "::add-mask::$SECRET_JSS_API_USER"
          [[ -n "$SECRET_JSS_API_PW" ]] && echo "::add-mask::$SECRET_JSS_API_PW"
          [[ -n "$SECRET_GH_TOKEN" ]] && echo "::add-mask::$SECRET_GH_TOKEN"

          # Check for secrets first, fall back to JSON if not present
          if [[ -n "$SECRET_JSS_URL" ]]; then
            JSS_URL="$SECRET_JSS_URL"
            JSS_API_USER="$SECRET_JSS_API_USER"
            JSS_API_PW="$SECRET_JSS_API_PW"
            GH_TOKEN="$SECRET_GH_TOKEN"
            echo "Using credentials from repository secrets"
          elif [ -f /tmp/autopkg-keys.json ]; then
            # Extract values from JSON file
            JSS_URL=$(jq -r '.JSS_URL' /tmp/autopkg-keys.json)
            JSS_API_USER=$(jq -r '.JSS_API_USER' /tmp/autopkg-keys.json)
            JSS_API_PW=$(jq -r '.JSS_API_PW' /tmp/autopkg-keys.json)
            GH_TOKEN=$(jq -r '.GH_TOKEN' /tmp/autopkg-keys.json)
            echo "Using credentials from dispatch payload"
          else
            echo "ERROR: No credentials found in secrets or JSON payload."
            exit 1
          fi

          # Mask derived values to ensure they're protected regardless of source
          [[ -n "$JSS_URL" ]] && echo "::add-mask::$JSS_URL"
          [[ -n "$JSS_API_USER" ]] && echo "::add-mask::$JSS_API_USER"
          [[ -n "$JSS_API_PW" ]] && echo "::add-mask::$JSS_API_PW"
          [[ -n "$GH_TOKEN" ]] && echo "::add-mask::$GH_TOKEN"

          # populate repo-list
          REPO_LIST=$(jq -r '.REPO_LIST' /tmp/autopkg-keys.json 2>/dev/null)
          if [[ -z $REPO_LIST || $REPO_LIST == "null" ]]; then
            REPO_LIST=repo-list.txt
          fi
          echo "Repo list used: $REPO_LIST"

          # run
          ./setup-jamfuploader.sh \
            --jss-url "$JSS_URL" \
            --jss-user "$JSS_API_USER" \
            --jss-pass "$JSS_API_PW" \
            --github-token "$GH_TOKEN" \
            --repo-list "$REPO_LIST"
      - name: Run recipes
        run: |
          chmod +x jamf-recipe-run.sh
          if [ -f /tmp/autopkg-keys.json ]; then
            # Build command with recipes and keys from JSON
            # should not be higher than -v in a public repo to avoid credential leaking into logs
            CMD="./jamf-recipe-run.sh -v"
            
            # Extract and add all RECIPE_* keys as --recipe parameters
            RECIPES=$(jq -r 'to_entries | .[] | select(.key | startswith("RECIPE_")) | .value' /tmp/autopkg-keys.json)
            while IFS= read -r recipe; do
              if [ -n "$recipe" ]; then
                CMD="$CMD --recipe \"$recipe\""
              fi
            done <<< "$RECIPES"
            
            # Extract unused keys (excluding RECIPE_*, JSS_URL, JSS_API_USER, JSS_API_PW, GH_TOKEN)
            EXTRA_KEYS=$(jq -r 'to_entries | .[] | select(.key | startswith("RECIPE_") | not) | select(.key != "JSS_URL" and .key != "JSS_API_USER" and .key != "JSS_API_PW" and .key != "GH_TOKEN") | "\(.key)=\(.value)"' /tmp/autopkg-keys.json)
            while IFS= read -r keyvalue; do
              if [ -n "$keyvalue" ]; then
                CMD="$CMD --key \"$keyvalue\""
              fi
            done <<< "$EXTRA_KEYS"
            
            # Execute the command
            eval $CMD
          else
            echo "ERROR: No JSON payload found for recipe run."
            exit 1
          fi

      # - name: Upload artifacts
      #   uses: actions/upload-artifact@v4
      #   if: always()
      #   with:
      #     name: autopkg-cache
      #     path: ~/Library/AutoPkg/Cache/
      #     retention-days: 1
